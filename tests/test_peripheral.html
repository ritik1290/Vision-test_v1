<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peripheral Vision Test - Vision Health Portal</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        #peripheral-screen {
            width: 100%;
            height: 400px;
            background: #333;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
            border-radius: 8px;
        }

        #fixation-point {
            width: 20px;
            height: 20px;
            background: red;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .stimulus {
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
            position: absolute;
            display: none;
            animation: flash 0.5s linear;
        }

        @keyframes flash {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <a href="../index.html" class="logo">
            <i class="fas fa-eye"></i> VisionHealth
        </a>
        <nav>
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="index.html" class="active">Vision Tests</a></li>
                <li><a href="../innovations.html">Innovations</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div id="step-intro" class="test-container">
            <h2>Peripheral Vision Test</h2>
            <p>This test checks your side vision (visual field). It helps detect blind spots.</p>
            <ul style="text-align: left; max-width: 500px; margin: 1rem auto;">
                <li>Sit close to the screen (about 30cm).</li>
                <li>Cover one eye.</li>
                <li><strong>Stare at the RED DOT in the center.</strong> Do not move your eyes.</li>
                <li>Click anywhere on the black area as soon as you see a white flash appear on the side.</li>
            </ul>
            <button id="btn-start" class="btn">Start Test</button>
        </div>

        <div id="step-test" class="test-container hidden">
            <div id="peripheral-screen">
                <div id="fixation-point"></div>
                <div id="stimulus" class="stimulus"></div>
            </div>
            <p>Keep looking at the red dot! Click when you see a flash.</p>
            <p>Flashes detected: <span id="score">0</span> / 10</p>
        </div>

        <div id="step-result" class="test-container hidden">
            <h2>Test Result</h2>
            <div id="result-message"></div>
            <div class="controls">
                <button onclick="location.reload()" class="btn-outline">Test Other Eye</button>
                <a href="index.html" class="btn">Back to Tests</a>
            </div>
        </div>
    </main>

    <script>
        let score = 0;
        let totalFlashes = 0;
        const maxFlashes = 10;
        let gameActive = false;
        let stimulusTimeout;

        const screen = document.getElementById('peripheral-screen');
        const stimulus = document.getElementById('stimulus');
        const scoreDisplay = document.getElementById('score');

        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('step-intro').classList.add('hidden');
            document.getElementById('step-test').classList.remove('hidden');
            gameActive = true;
            scheduleFlash();
        });

        screen.addEventListener('click', () => {
            if (!gameActive) return;
            // If stimulus is currently visible (or was very recently), count as hit
            if (stimulus.style.display === 'block') {
                score++;
                scoreDisplay.textContent = score;
                stimulus.style.display = 'none'; // Hide immediately to prevent double clicks
            }
        });

        function scheduleFlash() {
            if (totalFlashes >= maxFlashes) {
                endGame();
                return;
            }

            const delay = Math.random() * 2000 + 1000; // 1-3 seconds
            stimulusTimeout = setTimeout(showFlash, delay);
        }

        function showFlash() {
            if (!gameActive) return;

            totalFlashes++;

            // Random position (avoid center)
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * 150 + 50; // 50-200px from center
            const x = Math.cos(angle) * distance + 200; // Center is 200,200
            const y = Math.sin(angle) * distance + 200;

            stimulus.style.left = x + 'px';
            stimulus.style.top = y + 'px';
            stimulus.style.display = 'block';

            // Hide after short duration
            setTimeout(() => {
                stimulus.style.display = 'none';
                scheduleFlash();
            }, 600); // Flash duration
        }

        function endGame() {
            gameActive = false;
            document.getElementById('step-test').classList.add('hidden');
            document.getElementById('step-result').classList.remove('hidden');
            const msg = document.getElementById('result-message');

            if (score >= 8) {
                msg.innerHTML = `<h3 style="color: green;">Good Peripheral Vision</h3><p>You detected ${score} out of ${maxFlashes} flashes.</p>`;
            } else {
                msg.innerHTML = `<h3 style="color: orange;">Reduced Sensitivity</h3><p>You only detected ${score} out of ${maxFlashes} flashes. This might be due to distraction or a visual field defect.</p>`;
            }
        }
    </script>
</body>

</html>
